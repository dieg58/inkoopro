generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  userType  String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Client {
  id                    String    @id @default(cuid())
  odooId                Int?      @unique
  name                  String
  email                 String    @unique
  password              String?
  company               String?
  phone                 String?
  street                String?
  city                  String?
  zip                   String?
  country               String?
  defaultDeliveryMethod String?
  defaultDeliveryAddress Json?    // Adresse de livraison par défaut (si différente de l'adresse de facturation Odoo)
  status                String    @default("pending")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  approvedAt            DateTime?
  approvedBy            String?
  quotes                Quote[]

  @@index([email])
  @@index([odooId])
  @@index([status])
}

model Quote {
  id                      String    @id @default(cuid())
  clientId                String
  title                   String?
  status                  String    @default("draft")
  step                    String    @default("products")
  clientName              String
  clientEmail             String
  clientCompany           String?
  clientPhone             String?
  deliveryType            String
  deliveryAddress         Json?
  billingAddressDifferent Boolean   @default(false)
  billingAddress          Json?
  individualPackaging     Boolean   @default(false)
  newCarton               Boolean   @default(false)
  delayWorkingDays        Int
  delayType               String
  delayExpressDays        Int?
  selectedProducts        Json
  markings                Json
  quoteItems              Json
  totalHT                 Float
  totalTTC                Float?
  odooOrderId             Int?      @unique
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  submittedAt             DateTime?
  client                  Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

model ProductCache {
  id                String   @id @default(cuid())
  odooId            Int      @unique
  name              String
  defaultCode       String?
  supplierReference String?
  description       String?
  basePrice         Float
  category          String?
  availableColors   String
  availableSizes    String
  variantPrices     String?
  lastSync          DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([odooId])
  @@index([category])
  @@index([defaultCode])
  @@index([supplierReference])
  @@index([name])
}

model ServicePricing {
  id                         String   @id @default(cuid())
  technique                  String   @unique
  minQuantity                Int
  quantityRanges             String
  colorCounts                String?
  pointRanges                String?  // Rétrocompatibilité (à supprimer ultérieurement)
  pointRangesPetite          String?
  pointRangesGrande          String?
  dimensions                 String?
  prices                     String
  fixedFeePerColor           Float?
  fixedFeeSmallDigitization  Float?
  fixedFeeLargeDigitization  Float?
  smallDigitizationThreshold Int?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
  pricesClair                String?
  pricesFonce                String?
  pricesGrande               String?
  pricesPetite               String?
  serigraphieOptions         String?
}

model PricingConfig {
  id                        String   @id @default("singleton")
  textileDiscountPercentage Float    @default(30)
  clientProvidedIndexation  Float    @default(10)
  expressSurchargePercent   Float    @default(10)
  individualPackagingPrice  Float    @default(0.10)
  newCartonPrice            Float    @default(2.00)
  vectorizationPrice        Float    @default(25.00)
  courierPricePerKm         Float    @default(1.50) // Prix par km pour le coursier (€ HT)
  courierMinimumFee         Float    @default(15.00) // Forfait minimum pour le coursier (€ HT)
  updatedAt                 DateTime @updatedAt
}

model ServiceOdooMapping {
  id              String   @id @default(cuid())
  technique       String
  odooProductName String
  textileType     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([technique, textileType])
}

// Mapping des frais fixes et options vers des produits Odoo
model ServiceOdooFeeMapping {
  id              String   @id @default(cuid())
  mappingType     String   // 'fixedFee' | 'option'
  technique       String   // 'serigraphie' | 'broderie' | 'dtf'
  feeType         String?  // Pour fixedFee: 'colorFee' (sérigraphie), 'smallDigitization' | 'largeDigitization' (broderie)
  optionId        String?  // Pour option: l'ID de l'option (ex: 'discharge', 'gold', 'phospho')
  odooProductName String   // Nom du produit Odoo correspondant
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([mappingType, technique, feeType, optionId])
}

// Mapping des méthodes de livraison vers les références produits Odoo (default_code)
model DeliveryOdooMapping {
  id              String   @id @default(cuid())
  deliveryType    String   @unique // 'pickup' | 'dpd' | 'client_carrier' | 'courier'
  odooProductCode String   // Référence interne (default_code) du produit Odoo
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Mapping des options (emballage individuel, cartons neufs, vectorisation) vers les références produits Odoo (default_code)
model OptionOdooMapping {
  id              String   @id @default(cuid())
  optionType      String   @unique // 'individualPackaging' | 'newCarton' | 'vectorization'
  odooProductCode String   // Référence interne (default_code) du produit Odoo
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
